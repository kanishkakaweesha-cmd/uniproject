<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Online Delivery Management - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
      * { box-sizing: border-box; }
      body { 
        font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif; 
        margin: 0; 
        padding: 0;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
        min-height: 100vh;
        transition: background 0.3s ease;
      }

      /* Dark Theme - More friendly colors */
      body.dark-theme {
        background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
      }

      /* Quick Add Form */
      .quick-add-card {
        background: rgba(255,255,255,0.98);
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        transition: background 0.3s ease, box-shadow 0.3s ease;
      }

      body.dark-theme .quick-add-card {
        background: rgba(51, 65, 85, 0.95);
        box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      }

      body.dark-theme .quick-add-card h3,
      body.dark-theme #liveDataTitle,
      body.dark-theme #quickAddTitle {
        color: #ffffff;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.6rem;
        margin-bottom: 0.75rem;
      }

      /* Theme Toggle Button */
      .theme-toggle {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s;
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }

      body.dark-theme .theme-toggle {
        background: rgba(30, 41, 59, 0.8);
        border-color: rgba(148, 163, 184, 0.3);
        color: #e2e8f0;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
      }
      header { 
        background: rgba(255,255,255,0.98);
        padding: 1.25rem 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background 0.3s ease, box-shadow 0.3s ease;
      }

      body.dark-theme header {
        background: rgba(51, 65, 85, 0.95);
        box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      }

      .header-left { display: flex; align-items: center; gap: 16px; }
      .header-left h1 { margin: 0; font-size: 1.5rem; color: #1e293b; transition: color 0.3s ease; }
      body.dark-theme .header-left h1 { color: #f1f5f9; }
      .header-left img { height: 42px !important; }
      
      .header-center {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
      }
      
      #companyName { 
        color: #6366f1; 
        font-weight: 600; 
        font-size: 1rem; 
        padding: 0.5rem 1rem;
        background: rgba(99, 102, 241, 0.12);
        border-radius: 6px;
        border: 2px solid rgba(99, 102, 241, 0.25);
        transition: all 0.3s ease;
        white-space: nowrap;
      }
      body.dark-theme #companyName { 
        color: #a5b4fc;
        background: rgba(165, 180, 252, 0.15);
        border-color: rgba(165, 180, 252, 0.3);
      }

      body.dark-theme #headerDateTime {
        color: #94a3b8;
      }
      
      /* Top Stats Bar */
      .stats-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
      .stat-card {
        background: rgba(255,255,255,0.98);
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border-left: 4px solid #6366f1;
        transition: all 0.3s ease;
      }
      
      .stat-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
      }

      body.dark-theme .stat-card {
        background: rgba(51, 65, 85, 0.95);
        border-left-color: #818cf8;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      }
      
      body.dark-theme .stat-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      }

      .stat-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.4rem; transition: color 0.3s ease; font-weight: 600; }
      body.dark-theme .stat-label { color: #94a3b8; }
      .stat-value { font-size: 1.5rem; font-weight: 700; color: #1e293b; transition: color 0.3s ease; }
      body.dark-theme .stat-value { color: #f1f5f9; }
      
      /* Main Content Layout */
      .main-content {
        display: block;
        margin-bottom: 1rem;
      }
      
      /* Live Feed - Primary Focus */
      .live-feed-section {
        background: rgba(255,255,255,0.98);
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        transition: all 0.3s ease;
      }

      body.dark-theme .live-feed-section {
        background: rgba(51, 65, 85, 0.95);
        box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      }

      .section-title {
        margin: 0 0 0.75rem 0;
        font-size: 1.1rem;
        color: #1e293b;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: color 0.3s ease;
      }

      body.dark-theme .section-title {
        color: #f1f5f9;
      }
      
      .section-title::before {
        content: '‚óè';
        color: #10b981;
        font-size: 1.5rem;
        animation: pulse 2s ease-in-out infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      .table-container { 
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: border-color 0.3s ease;
      }

      body.dark-theme .table-container {
        border-color: #475569;
      }

      table { 
        width: 100%; 
        border-collapse: collapse; 
        background: #ffffff;
        font-size: 0.8rem;
        transition: background 0.3s ease;
      }

      body.dark-theme table {
        background: #334155;
      }

      th, td { 
        padding: 8px 6px; 
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
        transition: border-color 0.3s ease, color 0.3s ease;
      }

      body.dark-theme th,
      body.dark-theme td {
        border-bottom-color: #475569;
      }

      th {
        background: #f8fafc;
        font-weight: 600;
        color: #334155;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      body.dark-theme th {
        background: #1e293b;
        color: #cbd5e1;
      }

      td {
        color: #475569;
      }

      body.dark-theme td {
        color: #cbd5e1;
      }

      tr:hover {
        background: #f9fafb;
      }

      body.dark-theme tr:hover {
        background: #3b4d63;
      }

      tbody tr:hover { background: #f1f5f9; transition: background 0.2s ease; }
      body.dark-theme tbody tr:hover { background: #475569; }
      
      .btn-deliver {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.25);
      }
      .btn-deliver:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(99, 102, 241, 0.35);
      }
      
      .btn-print {
        color: #6366f1;
        text-decoration: none;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 6px;
        transition: color 0.2s ease;
      }
      .btn-print:hover { 
        text-decoration: underline;
        color: #4f46e5;
      }
      
      /* Right Sidebar */
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      
      .chart-card {
        background: rgba(255,255,255,0.98);
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        transition: background 0.3s ease, box-shadow 0.3s ease;
      }

      body.dark-theme .chart-card {
        background: rgba(51, 65, 85, 0.95);
        box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      }

      .chart-card h3 {
        margin: 0 0 0.75rem 0;
        font-size: 1rem;
        color: #1e293b;
        font-weight: 600;
        transition: color 0.3s ease;
      }

      body.dark-theme .chart-card h3 {
        color: #f1f5f9;
      }
      
      /* Quick Add Form */
      .quick-add-card {
        background: rgba(255,255,255,0.98);
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        transition: background 0.3s ease, box-shadow 0.3s ease;
      }

      body.dark-theme .quick-add-card {
        background: rgba(51, 65, 85, 0.95);
        box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.6rem;
        margin-bottom: 0.75rem;
      }
      .form-grid label {
        display: block;
        font-size: 0.75rem;
        color: #475569;
        font-weight: 600;
        margin-bottom: 0.2rem;
        transition: color 0.3s ease;
      }

      body.dark-theme .form-grid label {
        color: #cbd5e1;
      }

      .form-grid input, .form-grid select {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 0.8rem;
        transition: border 0.2s, background 0.3s ease, color 0.3s ease;
        background: #ffffff;
        color: #1e293b;
      }

      body.dark-theme .form-grid input,
      body.dark-theme .form-grid select {
        background: #334155;
        border-color: #475569;
        color: #f1f5f9;
      }

      .form-grid input:focus, .form-grid select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      body.dark-theme .form-grid input:focus,
      body.dark-theme .form-grid select:focus {
        border-color: #818cf8;
        box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.15);
      }
      .form-grid .full-width { grid-column: span 2; }
      
      .btn-submit {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #fff;
        border: none;
        padding: 8px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        width: 100%;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.25);
      }
      .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.35);
      }
      
      #formMessage {
        margin-top: 0.5rem;
        font-size: 0.8rem;
        text-align: center;
      }
      
      .btn-auth {
        background: #fff;
        color: #6366f1;
        border: 2px solid #6366f1;
        padding: 6px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        transition: all 0.2s;
      }
      .btn-auth:hover {
        background: #6366f1;
        color: #fff;
      }

      /* Modal Styles */
      .modal-content {
        background: #ffffff;
        padding: 16px;
        border-radius: 10px;
        max-width: 640px;
        margin: 40px auto;
        transition: background 0.3s ease, color 0.3s ease;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      body.dark-theme .modal-content {
        background: #334155;
        color: #f1f5f9;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      }

      .modal-content h3 {
        margin-top: 0;
        color: #1e293b;
        transition: color 0.3s ease;
      }

      body.dark-theme .modal-content h3 {
        color: #f1f5f9;
      }

      .modal-content label {
        color: #475569;
        transition: color 0.3s ease;
      }

      body.dark-theme .modal-content label {
        color: #cbd5e1;
      }

      .modal-content input {
        background: #ffffff;
        color: #1e293b;
        border: 1px solid #e2e8f0;
        transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }

      body.dark-theme .modal-content input {
        background: #1e293b;
        color: #f1f5f9;
        border-color: #475569;
      }

      .modal-content hr {
        border-color: #e2e8f0;
        transition: border-color 0.3s ease;
      }

      body.dark-theme .modal-content hr {
        border-color: #475569;
      }
      
      @media (max-width: 1200px) {
        .main-content { grid-template-columns: 1fr; }
        .sidebar { 
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 1rem;
        }
      }
      @media (max-width: 768px) {
        .sidebar { grid-template-columns: 1fr; }
        .stats-bar { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header style="position: relative;">
        <div class="header-left">
          <img src="/logo.png" alt="Logo" style="height:50px;display:block" onerror="this.src='/logo.svg'" />
          <h1>E-Deliver</h1>
        </div>
        <div class="header-center">
          <div id="companyName"></div>
          <div id="headerDateTime" style="font-size: 0.75rem; color: #64748b; margin-top: 0.3rem; font-weight: 500; transition: color 0.3s ease;"></div>
        </div>
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          <button class="theme-toggle" onclick="toggleTheme()">
            <span id="theme-icon">üåô</span>
            <span id="theme-text">Dark</span>
          </button>
          <button id="accountBtn" class="btn-auth" style="display:none" onclick="showAccountDetails()">üë§ Account</button>
          <button id="authAction" class="btn-auth">Login</button>
          <button id="logoutBtn" class="btn-auth" style="display:none">Logout</button>
        </div>
      </header>

      <!-- Top Stats Bar -->
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-label">Total Packages</div>
          <div class="stat-value"><%= (summary && typeof summary.totalPackages === 'number') ? summary.totalPackages : 0 %></div>
        </div>
        <div class="stat-card" style="border-left-color: #10b981;">
          <div class="stat-label">Total Revenue</div>
          <div class="stat-value">Rs. <%= (summary && typeof summary.totalRevenue === 'number') ? summary.totalRevenue.toFixed(2) : '0.00' %></div>
        </div>
        <div class="stat-card" style="border-left-color: #ed8936;">
          <div class="stat-label">Avg Weight</div>
          <div class="stat-value"><%= (summary && typeof summary.avgWeight === 'number') ? summary.avgWeight.toFixed(2) : '0.00' %> <span style="font-size:1rem;color:#718096">g</span></div>
        </div>
      </div>

      <!-- Live Data Display -->
      <div class="quick-add-card" style="margin-bottom: 1rem;">
        <h3 id="liveDataTitle" style="margin:0 0 0.75rem 0;font-size:1rem;color:#1e293b;font-weight:600;display:flex;align-items:center;gap:0.5rem;transition:color 0.3s ease;">
          <span style="animation: pulse 2s ease-in-out infinite;">üì°</span> Live Data
        </h3>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="background:#f8fafc;border-bottom:2px solid #e2e8f0;">
                <th style="padding:0.75rem;text-align:left;font-size:0.85rem;color:#475569;font-weight:600;">Weight (g)</th>
                <th style="padding:0.75rem;text-align:left;font-size:0.85rem;color:#475569;font-weight:600;">Volume (cm¬≥)</th>
                <th style="padding:0.75rem;text-align:left;font-size:0.85rem;color:#475569;font-weight:600;">Price (Rs.)</th>
                <th style="padding:0.75rem;text-align:center;font-size:0.85rem;color:#475569;font-weight:600;">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr id="liveEsp32Row" style="border-bottom:1px solid #e2e8f0;">
                <td style="padding:0.75rem;font-size:0.95rem;font-weight:600;color:#1e293b;" id="liveWeight">‚Äî</td>
                <td style="padding:0.75rem;font-size:0.95rem;font-weight:600;color:#1e293b;" id="liveVolume">‚Äî</td>
                <td style="padding:0.75rem;font-size:0.95rem;font-weight:600;color:#10b981;" id="livePrice">‚Äî</td>
                <td style="padding:0.75rem;text-align:center;">
                  <button onclick="addLiveDataToForm()" class="btn-deliver" style="background:#10b981;font-size:0.85rem;padding:0.5rem 1rem;">
                    ‚ûï Add to Form
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div style="margin-top:0.5rem;font-size:0.75rem;color:#f59e0b;text-align:center;" id="liveDataStatus">
          ‚ö† Waiting for ESP32 data...
        </div>
      </div>

      <!-- Quick Add Form (moved to top) -->
      <div class="quick-add-card" style="margin-bottom: 1rem;">
        <h3 id="quickAddTitle" style="margin:0 0 0.75rem 0;font-size:1rem;color:#1e293b;font-weight:600;transition:color 0.3s ease;">‚ûï Quick Add Item</h3>
        <form id="addForm">
          <div class="form-grid">
            <div>
              <label>Weight (g)</label>
              <input id="weight" name="weight" type="number" step="0.01" required />
            </div>
            <div>
              <label>Volume (cm¬≥)</label>
              <input id="volume" name="volume" type="number" step="0.01" required />
            </div>
            <div>
              <label>Fee Type</label>
              <select id="feeType" name="feeType">
                <option value="A">A (small)</option>
                <option value="B">B (medium)</option>
                <option value="C">C (large)</option>
              </select>
            </div>
            <div>
              <label>Phone</label>
              <input id="phone" name="phone" type="text" required />
            </div>
            <div class="full-width">
              <label>Price (Rs.)</label>
              <input id="price" name="price" type="number" step="0.01" readonly style="background:#f8fafc;cursor:not-allowed;" />
            </div>
            <div class="full-width">
              <label>Customer Name</label>
              <input id="customerName" name="customerName" type="text" required />
            </div>
            <div class="full-width">
              <label>Address</label>
              <input id="address" name="address" type="text" required />
            </div>
            <div>
              <label>Postal Code</label>
              <input id="postalCode" name="postalCode" type="text" required />
            </div>
            <div>
              <label>Email</label>
              <input id="email" name="email" type="email" />
            </div>
          </div>
          <button id="addSubmit" type="submit" class="btn-submit">Add Item</button>
          <div id="formMessage"></div>
        </form>
      </div>

      <!-- Main Content: Live Feed + Chart Sidebar -->
      <div class="main-content">
        <!-- Live Feed Table (Primary) -->
        <div class="live-feed-section">
          <h2 class="section-title">Delivery Packages</h2>
          <div class="table-container">
            <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Item #</th>
            <th>Barcode</th>
            <th>Weight</th>
            <th>Volume</th>
            <th>Fee Type</th>
            <th>Fee</th>
            <th>Company</th>
            <th>Customer</th>
            <th>Address</th>
            <th>Postal</th>
            <th>Phone</th>
            <th>Email</th>
            <th>User ID</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="deliveryPackagesTbody">
          <% if (recentPackages && recentPackages.length) { %>
            <% for (var i=0;i<recentPackages.length;i++) { var pkg = recentPackages[i]; %>
              <tr>
                <td><%= pkg.timestamp ? new Date(pkg.timestamp).toLocaleString() : '' %></td>
                <td><strong><%= pkg.itemNumber || '‚Äî' %></strong></td>
                <td style="font-family:monospace;font-size:0.85rem"><%= pkg.barcode || '‚Äî' %></td>
                <td><strong><%= (typeof pkg.weight === 'number') ? pkg.weight.toFixed(2) : pkg.weight %></strong></td>
                <td><strong><%= (typeof pkg.volume === 'number') ? pkg.volume.toFixed(2) : pkg.volume %></strong></td>
                <td><span style="background:#6366f1;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.8rem"><%= pkg.feeType %></span></td>
                <td><strong style="color:#10b981">Rs. <%= (typeof pkg.fee === 'number') ? pkg.fee.toFixed(2) : pkg.fee %></strong></td>
                <td><%= pkg.deliveryCompany || '‚Äî' %></td>
                <td><%= pkg.customerName || '‚Äî' %></td>
                <td style="font-size:0.85rem"><%= pkg.address || '‚Äî' %></td>
                <td><%= pkg.postalCode || '‚Äî' %></td>
                <td><%= pkg.phone || '‚Äî' %></td>
                <td style="font-size:0.85rem"><%= pkg.email || '‚Äî' %></td>
                <td style="font-size:0.8rem;color:#718096"><%= pkg.userId || '‚Äî' %></td>
                <td style="white-space:nowrap">
                  <% if (pkg.status === 'delivered') { %>
                    <button class="btn-deliver" style="background:#27ae60;cursor:default;opacity:0.9" disabled>‚úì Delivery Completed</button>
                  <% } else { %>
                    <button onclick="openDeliverModal('<%= pkg._id %>')" class="btn-deliver">üì¶ Deliver Now</button>
                  <% } %>
                  <a href="/label/<%= pkg._id %>" target="_blank" class="btn-print">üñ® Print</a>
                  <button onclick="deletePackage('<%= pkg._id %>')" class="btn-delete" style="background:#ef4444;color:#fff;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;margin-left:4px;" title="Delete this item">üóëÔ∏è</button>
                </td>
              </tr>
            <% } %>
          <% } else { %>
            <tr><td colspan="15" style="text-align:center;padding:2rem;color:#718096">No packages yet. Add your first item or wait for ESP32 data.</td></tr>
          <% } %>
        </tbody>
      </table>
          </div>
        </div>

        <!-- Chart moved below Live Feed -->
        <div class="live-feed-section" style="margin-top: 1rem;">
          <h2 class="section-title">üìä Packages by Fee Type</h2>
          <div style="max-width: 500px; margin: 0 auto;">
            <canvas id="feeChart" width="400" height="400"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Account Details Modal -->
    <div id="accountModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
      <div style="background:#fff; padding:1.25rem; border-radius:10px; max-width:420px; width:88%; box-shadow:0 8px 30px rgba(0,0,0,0.25); transition: background 0.3s ease;">
        <h2 style="margin:0 0 1rem 0; color:#1e293b; font-size:1.2rem; transition: color 0.3s ease;">üë§ Account Details</h2>
        
        <div style="display:grid; gap:0.75rem; margin-bottom:1rem;">
          <div>
            <label style="display:block; font-weight:600; color:#475569; margin-bottom:0.25rem; font-size:0.8rem; transition: color 0.3s ease;">Company Name</label>
            <input id="accountCompanyName" readonly style="width:100%; padding:0.6rem; border:1px solid #e2e8f0; border-radius:5px; background:#f8fafc; color:#1e293b; font-size:0.85rem; transition: all 0.3s ease;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#475569; margin-bottom:0.25rem; font-size:0.8rem; transition: color 0.3s ease;">Email</label>
            <input id="accountEmail" readonly style="width:100%; padding:0.6rem; border:1px solid #e2e8f0; border-radius:5px; background:#f8fafc; color:#1e293b; font-size:0.85rem; transition: all 0.3s ease;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#475569; margin-bottom:0.25rem; font-size:0.8rem; transition: color 0.3s ease;">Phone Number</label>
            <input id="accountPhone" readonly style="width:100%; padding:0.6rem; border:1px solid #e2e8f0; border-radius:5px; background:#f8fafc; color:#1e293b; font-size:0.85rem; transition: all 0.3s ease;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#475569; margin-bottom:0.25rem; font-size:0.8rem; transition: color 0.3s ease;">Address</label>
            <input id="accountAddress" readonly style="width:100%; padding:0.6rem; border:1px solid #e2e8f0; border-radius:5px; background:#f8fafc; color:#1e293b; font-size:0.85rem; transition: all 0.3s ease;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#475569; margin-bottom:0.25rem; font-size:0.8rem; transition: color 0.3s ease;">Postal Code</label>
            <input id="accountPostalCode" readonly style="width:100%; padding:0.6rem; border:1px solid #e2e8f0; border-radius:5px; background:#f8fafc; color:#1e293b; font-size:0.85rem; transition: all 0.3s ease;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#475569; margin-bottom:0.25rem; font-size:0.8rem; transition: color 0.3s ease;">Machine Code</label>
            <input id="accountMachineCode" readonly style="width:100%; padding:0.6rem; border:1px solid #e2e8f0; border-radius:5px; background:#f8fafc; color:#1e293b; font-size:0.85rem; transition: all 0.3s ease;">
          </div>
        </div>
        
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
          <button onclick="restartAccount()" style="flex:1; min-width:130px; padding:0.6rem 1rem; background:#f59e0b; color:#fff; border:none; border-radius:5px; font-weight:600; cursor:pointer; font-size:0.85rem; transition:all 0.3s; display:flex; align-items:center; justify-content:center; gap:0.4rem;" onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'">
            üîÑ Restart
          </button>
          <button onclick="deleteAccount()" style="flex:1; min-width:130px; padding:0.6rem 1rem; background:#ef4444; color:#fff; border:none; border-radius:5px; font-weight:600; cursor:pointer; font-size:0.85rem; transition:all 0.3s; display:flex; align-items:center; justify-content:center; gap:0.4rem;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
            üóëÔ∏è Delete
          </button>
          <button onclick="closeAccountModal()" style="flex:1; min-width:130px; padding:0.6rem 1rem; background:#6366f1; color:#fff; border:none; border-radius:5px; font-weight:600; cursor:pointer; font-size:0.85rem; transition:all 0.3s;" onmouseover="this.style.background='#4f46e5'" onmouseout="this.style.background='#6366f1'">
            Close
          </button>
        </div>
      </div>
    </div>

    <script>
      // Update date and time in header
      function updateDateTime() {
        const now = new Date();
        const options = { 
          weekday: 'short', 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: true
        };
        const dateTimeString = now.toLocaleString('en-US', options);
        const headerDateTime = document.getElementById('headerDateTime');
        if (headerDateTime) {
          headerDateTime.textContent = dateTimeString;
        }
      }

      // Update time every second
      setInterval(updateDateTime, 1000);
      updateDateTime(); // Initial call

      // Dark theme support for account modal
      const accountModalContent = document.querySelector('#accountModal > div');
      const accountModalTitle = document.querySelector('#accountModal h2');
      const accountModalInputs = document.querySelectorAll('#accountModal input');
      const accountModalLabels = document.querySelectorAll('#accountModal label');
      
      function updateAccountModalTheme() {
        if (document.body.classList.contains('dark-theme')) {
          accountModalContent.style.background = '#1e293b';
          accountModalTitle.style.color = '#e2e8f0';
          accountModalInputs.forEach(input => {
            input.style.background = '#0f172a';
            input.style.borderColor = '#475569';
            input.style.color = '#f1f5f9';
          });
          accountModalLabels.forEach(label => {
            label.style.color = '#cbd5e1';
          });
        } else {
          accountModalContent.style.background = '#fff';
          accountModalTitle.style.color = '#1e293b';
          accountModalInputs.forEach(input => {
            input.style.background = '#f8fafc';
            input.style.borderColor = '#e2e8f0';
            input.style.color = '#1e293b';
          });
          accountModalLabels.forEach(label => {
            label.style.color = '#475569';
          });
        }
      }

      // Enhanced Theme toggle functionality with smooth transitions
      function toggleTheme() {
        const body = document.body;
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');
        const themeButton = document.querySelector('.theme-toggle');
        
        // Add transition class for smooth switching
        body.style.transition = 'background 0.5s ease, color 0.5s ease';
        
        // Toggle theme
        const isDark = body.classList.toggle('dark-theme');
        
        // Update button with animation
        if (themeButton) {
          themeButton.style.transform = 'scale(0.9)';
          setTimeout(() => {
            themeButton.style.transform = 'scale(1)';
          }, 150);
        }
        
        // Update icon and text with smooth fade
        if (themeIcon && themeText) {
          themeIcon.style.opacity = '0';
          themeText.style.opacity = '0';
          
          setTimeout(() => {
            if (isDark) {
              themeIcon.textContent = '‚òÄÔ∏è';
              themeText.textContent = 'Light';
              localStorage.setItem('theme', 'dark');
            } else {
              themeIcon.textContent = 'üåô';
              themeText.textContent = 'Dark';
              localStorage.setItem('theme', 'light');
            }
            themeIcon.style.opacity = '1';
            themeText.style.opacity = '1';
          }, 150);
        }
        
        // Update account modal theme if it exists
        updateAccountModalTheme();
        
        // Show a subtle notification
        showThemeNotification(isDark ? 'Dark theme enabled' : 'Light theme enabled');
      }
      
      // Show theme change notification
      function showThemeNotification(message) {
        const existingNotif = document.getElementById('theme-notification');
        if (existingNotif) existingNotif.remove();
        
        const notification = document.createElement('div');
        notification.id = 'theme-notification';
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: rgba(102, 126, 234, 0.95);
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-size: 0.9rem;
          font-weight: 600;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          z-index: 10000;
          animation: slideIn 0.3s ease;
          transition: opacity 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.opacity = '0';
          setTimeout(() => notification.remove(), 300);
        }, 2000);
      }
      
      // Add CSS animation for notification
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        .theme-toggle {
          transition: all 0.3s ease !important;
        }
        #theme-icon, #theme-text {
          transition: opacity 0.15s ease;
        }
      `;
      document.head.appendChild(style);

      // Load saved theme preference with smooth initialization
      (function() {
        const savedTheme = localStorage.getItem('theme');
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');
        
        if (savedTheme === 'dark') {
          document.body.classList.add('dark-theme');
          if (themeIcon) themeIcon.textContent = '‚òÄÔ∏è';
          if (themeText) themeText.textContent = 'Light';
        }
        
        // Add keyboard shortcut (Ctrl/Cmd + Shift + T)
        document.addEventListener('keydown', function(e) {
          if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
            e.preventDefault();
            toggleTheme();
          }
        });
      })();

      // auth state and helper
      var currentUser = null;
      async function loadUser() {
        try {
          var r = await fetch('/auth/me');
          var j = await r.json();
          currentUser = j.user || null;
          var companyNameEl = document.getElementById('companyName');
          var authAction = document.getElementById('authAction');
          var logoutBtn = document.getElementById('logoutBtn');
          var accountBtn = document.getElementById('accountBtn');
          if (currentUser) {
            companyNameEl.textContent = currentUser.companyName || 'Delivery Company';
            authAction.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            accountBtn.style.display = 'inline-block';
          } else {
            companyNameEl.textContent = '';
            authAction.style.display = 'inline-block';
            logoutBtn.style.display = 'none';
            accountBtn.style.display = 'none';
          }

          authAction.onclick = function(){ location.href = '/auth/login'; };
          logoutBtn.onclick = async function(){ await fetch('/auth/logout',{method:'POST'}); location.reload(); };
        } catch (e) { console.error('loadUser', e); }
      }
      loadUser();

      // Account Details Modal Functions
      function showAccountDetails() {
        if (!currentUser) {
          alert('Please login to view account details');
          return;
        }
        
        document.getElementById('accountCompanyName').value = currentUser.companyName || '';
        document.getElementById('accountEmail').value = currentUser.email || '';
        document.getElementById('accountPhone').value = currentUser.phone || '';
        document.getElementById('accountAddress').value = currentUser.address || '';
        document.getElementById('accountPostalCode').value = currentUser.postalCode || '';
        document.getElementById('accountMachineCode').value = currentUser.machineCode || 'Not assigned';
        
        updateAccountModalTheme();
        document.getElementById('accountModal').style.display = 'flex';
      }

      function closeAccountModal() {
        document.getElementById('accountModal').style.display = 'none';
      }

      async function restartAccount() {
        if (!currentUser) {
          alert('No user logged in');
          return;
        }
        
        const confirmed = confirm(
          'üîÑ RESTART ACCOUNT\n\n' +
          'This will delete ALL packages and deliveries associated with your account.\n' +
          'Your account information will remain intact, but all delivery data will be cleared.\n\n' +
          'Company: ' + (currentUser.companyName || '') + '\n' +
          'Email: ' + (currentUser.email || '') + '\n\n' +
          'Do you want to restart your account from the beginning?'
        );
        
        if (!confirmed) return;
        
        const doubleCheck = confirm('‚ö†Ô∏è Final confirmation: Delete ALL packages and start fresh?');
        if (!doubleCheck) return;
        
        try {
          const res = await fetch('/auth/restart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (res.ok) {
            const data = await res.json();
            closeAccountModal();
            alert('‚úì Account restarted successfully!\n\n' + data.deletedPackages + ' packages were deleted.\n\nThe page will now reload.');
            location.reload();
          } else {
            const data = await res.json();
            alert('Failed to restart account: ' + (data.error || 'Unknown error'));
          }
        } catch (e) {
          console.error('restartAccount error', e);
          alert('Failed to restart account: ' + e.message);
        }
      }

      async function deleteAccount() {
        if (!currentUser) {
          alert('No user logged in');
          return;
        }
        
        const confirmed = confirm(
          '‚ö†Ô∏è WARNING: This will permanently delete your account and all associated data!\n\n' +
          'Company: ' + (currentUser.companyName || '') + '\n' +
          'Email: ' + (currentUser.email || '') + '\n\n' +
          'Are you absolutely sure you want to delete your account?'
        );
        
        if (!confirmed) return;
        
        const doubleCheck = confirm('This action CANNOT be undone. Delete account permanently?');
        if (!doubleCheck) return;
        
        try {
          const res = await fetch('/auth/account', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (res.ok) {
            alert('Account deleted successfully. You will be redirected to the login page.');
            location.href = '/auth/login';
          } else {
            const data = await res.json();
            alert('Failed to delete account: ' + (data.error || 'Unknown error'));
          }
        } catch (e) {
          console.error('deleteAccount error', e);
          alert('Failed to delete account: ' + e.message);
        }
      }

      // chart data injected from server
      var chartData = <%- JSON.stringify(chart || []) %>;

      // Fee rates (match server/ESP logic)
      var feeRates = { A: 0.1, B: 0.2, C: 0.3 };

      // Calculate and update price based on weight, volume, and fee type
      function calculatePrice() {
        var weight = parseFloat(document.getElementById('weight').value) || 0;
        var volume = parseFloat(document.getElementById('volume').value) || 0;
        var feeType = document.getElementById('feeType').value || 'A';
        var rate = feeRates[feeType] || feeRates.A;
        var price = (rate * weight * volume) / 10;
        document.getElementById('price').value = price.toFixed(2);
      }

      // Add event listeners to recalculate price when inputs change
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('weight').addEventListener('input', calculatePrice);
        document.getElementById('volume').addEventListener('input', calculatePrice);
        document.getElementById('feeType').addEventListener('change', calculatePrice);
      });

      // Helper: render pie chart and return chart instance
      function renderChart(data) {
        var labels = data.map(function(it){ return it._id });
        var counts = data.map(function(it){ return it.count });
        var ctx = document.getElementById('feeChart').getContext('2d');
        return new Chart(ctx, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{ data: counts, backgroundColor: ['#1abc9c','#3498db','#e67e22','#9b59b6','#e74c3c'] }]
          }
        });
      }

      var feeChart;
      try {
        feeChart = renderChart(chartData);
      } catch (e) {
        console.error('chart render error', e);
      }

      // Add form handling
      document.getElementById('addForm').addEventListener('submit', async function (ev) {
        ev.preventDefault();
        if (!currentUser) {
          var msgEl = document.getElementById('formMessage');
          msgEl.style.color = 'crimson';
          msgEl.textContent = 'Please log in before adding a package.';
          return;
        }
        var w = parseFloat(document.getElementById('weight').value) || 0;
        var v = parseFloat(document.getElementById('volume').value) || 0;
        var t = document.getElementById('feeType').value || 'A';
        var k = feeRates[t] || feeRates.A;
        var fee = (k * w * v) / 10;

        var payload = {
          weight: w,
          volume: v,
          feeType: t,
          fee: fee,
          customerName: document.getElementById('customerName').value || '',
          address: document.getElementById('address').value || '',
          postalCode: document.getElementById('postalCode').value || '',
          phone: document.getElementById('phone').value || '',
          email: document.getElementById('email').value || ''
        };
        var msgEl = document.getElementById('formMessage');
        msgEl.style.color = '#333';
        msgEl.textContent = 'Sending...';

        try {
          var res = await fetch('/api/packages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            var errBody = await res.json().catch(()=>({}));
            throw new Error(errBody.errors ? errBody.errors.join('; ') : ('Server returned ' + res.status));
          }
          var data = await res.json();
          msgEl.style.color = 'green';
          msgEl.textContent = 'Item added ‚úì (ID: ' + (data._id || '-') + ')';
          // clear form
          document.getElementById('addForm').reset();

          // refresh recent packages and chart
          refreshRecent();
          refreshChart();
        } catch (err) {
          console.error(err);
          msgEl.style.color = 'crimson';
          msgEl.textContent = 'Failed to add item: ' + (err.message || err);
        }
      });

      // Refresh recent packages table
      async function refreshRecent() {
        try {
          var res = await fetch('/api/packages/recent');
          if (!res.ok) throw new Error('Status ' + res.status);
          var arr = await res.json();
          var tbody = document.getElementById('deliveryPackagesTbody');
          if (!tbody) {
            console.error('Delivery packages tbody not found');
            return;
          }
          if (!arr || !arr.length) {
            tbody.innerHTML = '<tr><td colspan="15">No packages</td></tr>';
            return;
          }
          tbody.innerHTML = arr.map(function(pkg){
            var deliverButton = pkg.status === 'delivered' 
              ? '<button class="btn-deliver" style="background:#27ae60;cursor:default;opacity:0.9" disabled>‚úì Delivery Completed</button>'
              : '<button onclick="openDeliverModal(\'' + pkg._id + '\')" class="btn-deliver">üì¶ Deliver Now</button>';
            
            var deleteButton = '<button onclick="deletePackage(\'' + pkg._id + '\')" class="btn-delete" style="background:#ef4444;color:#fff;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;margin-left:4px;" title="Delete this item">üóëÔ∏è</button>';
            
            return '<tr>' +
              '<td>' + (pkg.timestamp ? new Date(pkg.timestamp).toLocaleString() : '') + '</td>' +
              '<td><strong>' + (pkg.itemNumber || '‚Äî') + '</strong></td>' +
              '<td style="font-family:monospace;font-size:0.85rem">' + (pkg.barcode || '‚Äî') + '</td>' +
              '<td><strong>' + (typeof pkg.weight === 'number' ? pkg.weight.toFixed(2) : pkg.weight) + '</strong></td>' +
              '<td><strong>' + (typeof pkg.volume === 'number' ? pkg.volume.toFixed(2) : pkg.volume) + '</strong></td>' +
              '<td><span style="background:#6366f1;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.8rem">' + pkg.feeType + '</span></td>' +
              '<td><strong style="color:#10b981">Rs. ' + (typeof pkg.fee === 'number' ? pkg.fee.toFixed(2) : pkg.fee) + '</strong></td>' +
              '<td>' + (pkg.deliveryCompany || '‚Äî') + '</td>' +
              '<td>' + (pkg.customerName || '‚Äî') + '</td>' +
              '<td style="font-size:0.85rem">' + (pkg.address || '‚Äî') + '</td>' +
              '<td>' + (pkg.postalCode || '‚Äî') + '</td>' +
              '<td>' + (pkg.phone || '‚Äî') + '</td>' +
              '<td style="font-size:0.85rem">' + (pkg.email || '‚Äî') + '</td>' +
              '<td style="font-size:0.8rem;color:#718096">' + (pkg.userId || '‚Äî') + '</td>' +
              '<td style="white-space:nowrap">' + deliverButton + ' <a href="/label/' + pkg._id + '" target="_blank" class="btn-print">üñ® Print</a>' + deleteButton + '</td>' +
            '</tr>';
          }).join('');
        } catch (e) {
          console.error('refreshRecent error', e);
        }
      }

      // Deliver Now modal and actions
      (function(){
        var modal = document.createElement('div');
        modal.id = 'deliverModal';
        modal.style.display = 'none';
        modal.style.position = 'fixed';
        modal.style.left = '0'; modal.style.top = '0'; modal.style.width = '100%'; modal.style.height = '100%';
        modal.style.background = 'rgba(0,0,0,0.4)'; modal.style.alignItems = 'center'; modal.style.justifyContent = 'center';
        modal.innerHTML = '<div class="modal-content">' +
          '<h3>Deliver Item</h3>' +
          '<div style="display:flex;gap:12px;align-items:flex-start">' +
            '<div style="flex:1">' +
              '<label>Company Name<br/><input id="modalCompanyName" style="width:100%" readonly></label><br/>' +
              '<label>Company Address<br/><input id="modalCompanyAddress" style="width:100%" readonly></label><br/>' +
              '<label>Company Email<br/><input id="modalCompanyEmail" style="width:100%" readonly></label><br/>' +
              '<label>Company Phone<br/><input id="modalCompanyPhone" style="width:100%" readonly></label><br/>' +
              '<label>Company Postal<br/><input id="modalCompanyPostal" style="width:100%" readonly></label><br/>' +
            '</div>' +
            '<div style="width:220px">' +
              '<label>Barcode<br/><svg id="modalBarcode"></svg></label><br/>' +
              '<label>Item #<br/><input id="modalItemNumber" style="width:100%" readonly></label>' +
            '</div>' +
          '</div>' +
          '<hr/>' +
          '<div>' +
            '<label>Customer Name (required)<br/><input id="modalCustomerName" style="width:100%"></label><br/>' +
            '<label>Telephone (required)<br/><input id="modalCustomerPhone" style="width:100%"></label><br/>' +
            '<label>Address (required)<br/><input id="modalCustomerAddress" style="width:100%"></label><br/>' +
            '<label>Postal Code<br/><input id="modalCustomerPostal" style="width:100%"></label><br/>' +
            '<label>Email<br/><input id="modalCustomerEmail" style="width:100%"></label><br/>' +
          '</div>' +
          '<div style="margin-top:8px;text-align:right">' +
            '<button id="modalCancel" style="margin-right:8px">Cancel</button>' +
            '<button id="modalSave" style="background:#27ae60;color:#fff;padding:8px 12px;border:none;border-radius:5px;cursor:pointer;">Save the item</button>' +
          '</div>' +
        '</div>';
        document.body.appendChild(modal);

        modal.querySelector('#modalCancel').addEventListener('click', function(){ modal.style.display = 'none'; });
        modal.querySelector('#modalSave').addEventListener('click', async function(){
          var pkgId = modal.getAttribute('data-pkgid');
          var payload = {
            customerName: document.getElementById('modalCustomerName').value || '',
            phone: document.getElementById('modalCustomerPhone').value || '',
            address: document.getElementById('modalCustomerAddress').value || '',
            postalCode: document.getElementById('modalCustomerPostal').value || '',
            email: document.getElementById('modalCustomerEmail').value || ''
          };
          // basic client validation
          if (!payload.customerName || !payload.phone || !payload.address) {
            alert('Please fill required fields: Customer name, telephone and address');
            return;
          }
          try {
            var res = await fetch('/api/packages/' + pkgId + '/deliver', {
              method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
            });
            if (!res.ok) {
              var err = await res.json().catch(()=>({}));
              throw new Error(err.errors ? (err.errors.join('; ')) : ('Status ' + res.status));
            }
            var saved = await res.json();
            modal.style.display = 'none';
            refreshRecent();
            // open printable label
            window.open('/label/' + saved._id, '_blank');
          } catch (e) {
            console.error('deliver save error', e);
            alert('Failed to save: ' + (e.message||e));
          }
        });
      })();

      // open modal and populate fields
      async function openDeliverModal(pkgId) {
        try {
          var res = await fetch('/api/packages/' + pkgId);
          if (!res.ok) throw new Error('Status ' + res.status);
          var pkg = await res.json();
          var modal = document.getElementById('deliverModal');
          modal.setAttribute('data-pkgid', pkgId);
          // populate company info from currentUser if available
          document.getElementById('modalCompanyName').value = (currentUser && currentUser.companyName) || (pkg.deliveryCompany || '');
          document.getElementById('modalCompanyAddress').value = (currentUser && currentUser.address) || '';
          document.getElementById('modalCompanyEmail').value = (currentUser && currentUser.email) || '';
          document.getElementById('modalCompanyPhone').value = (currentUser && currentUser.phone) || '';
          document.getElementById('modalCompanyPostal').value = (currentUser && currentUser.postalCode) || '';
          document.getElementById('modalItemNumber').value = pkg.itemNumber || String(Math.floor(Date.now()/1000));
          document.getElementById('modalCustomerName').value = pkg.customerName || '';
          document.getElementById('modalCustomerPhone').value = pkg.phone || '';
          document.getElementById('modalCustomerAddress').value = pkg.address || '';
          document.getElementById('modalCustomerPostal').value = pkg.postalCode || '';
          document.getElementById('modalCustomerEmail').value = pkg.email || '';

          // render barcode using pkg.barcode or pkg._id
          var bc = pkg.barcode || pkg._id;
          try { JsBarcode('#modalBarcode', bc, {format:'CODE128', displayValue:true, width:1, height:30}); } catch(e){ console.error('barcode err', e); }

          modal.style.display = 'flex';
        } catch (e) { console.error('openDeliverModal error', e); alert('Failed to open deliver form: '+(e.message||e)); }
      }

      // Delete package function
      async function deletePackage(packageId) {
        if (!currentUser) {
          alert('Please login to delete packages');
          return;
        }
        
        const confirmed = confirm('‚ö†Ô∏è Are you sure you want to delete this package?\n\nThis action cannot be undone.');
        if (!confirmed) return;
        
        try {
          const res = await fetch('/api/packages/' + packageId, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.error || 'Failed to delete package');
          }
          
          // Refresh the table and stats
          await refreshRecent();
          alert('‚úì Package deleted successfully');
          
          // Optionally refresh the chart
          refreshChart();
        } catch (e) {
          console.error('deletePackage error', e);
          alert('Failed to delete package: ' + e.message);
        }
      }

      // Live Data Functions
      var latestEsp32Data = null;
      var isEsp32Connected = false;
      var liveEventSource = null;
      var livePollingTimer = null;
      var liveReconnectTimer = null;
      var lastRecentRefresh = 0;
      var lastChartRefresh = 0;

      function updateLiveDisplay(data) {
        const weightEl = document.getElementById('liveWeight');
        const volumeEl = document.getElementById('liveVolume');
        const priceEl = document.getElementById('livePrice');
        const statusEl = document.getElementById('liveDataStatus');
        if (!weightEl || !volumeEl || !priceEl || !statusEl) return;

        const numericWeight = data && data.weight !== null ? Number(data.weight) : null;
        const numericVolume = data && data.volume !== null ? Number(data.volume) : null;
        const numericPrice = data && data.price !== null ? Number(data.price) : null;

        const isValid = Number.isFinite(numericWeight) && Number.isFinite(numericVolume) && Number.isFinite(numericPrice);

        if (isValid) {
          isEsp32Connected = true;
          latestEsp32Data = {
            weight: numericWeight,
            volume: numericVolume,
            price: numericPrice,
            feeType: data.feeType || null,
            timestamp: data.timestamp || null,
            _id: data._id || null
          };

          weightEl.textContent = numericWeight.toFixed(2);
          volumeEl.textContent = numericVolume.toFixed(2);
          priceEl.textContent = 'Rs. ' + numericPrice.toFixed(2);

          const timestamp = latestEsp32Data.timestamp ? new Date(latestEsp32Data.timestamp).toLocaleTimeString() : '';
          statusEl.textContent = '‚úì Connected ‚Ä¢ Last updated: ' + timestamp;
          statusEl.style.color = '#10b981';

          if (latestEsp32Data._id) {
            const now = Date.now();
            if (now - lastRecentRefresh > 2000) {
              lastRecentRefresh = now;
              refreshRecent();
            }
            if (now - lastChartRefresh > 15000) {
              lastChartRefresh = now;
              refreshChart();
            }
          }
        } else {
          isEsp32Connected = false;
          latestEsp32Data = null;
          weightEl.textContent = '‚Äî';
          volumeEl.textContent = '‚Äî';
          priceEl.textContent = '‚Äî';
          statusEl.textContent = '‚ö† Waiting for ESP32 data...';
          statusEl.style.color = '#f59e0b';
        }
      }

      async function fetchLiveEsp32Data() {
        try {
          const res = await fetch('/api/esp32/latest');
          if (!res.ok) throw new Error('Status ' + res.status);
          const data = await res.json();
          updateLiveDisplay(data);
        } catch (e) {
          console.error('fetchLiveEsp32Data error', e);
          updateLiveDisplay(null);
          const statusEl = document.getElementById('liveDataStatus');
          if (statusEl) {
            statusEl.textContent = '‚úó Disconnected ‚Ä¢ Error loading data';
            statusEl.style.color = '#ef4444';
          }
        }
      }

      function startLivePolling() {
        if (livePollingTimer) return;
        fetchLiveEsp32Data();
        livePollingTimer = setInterval(fetchLiveEsp32Data, 5000);
      }

      function stopLivePolling() {
        if (!livePollingTimer) return;
        clearInterval(livePollingTimer);
        livePollingTimer = null;
      }

      function connectLiveStream() {
        if (!window.EventSource) {
          startLivePolling();
          return;
        }

        stopLivePolling();

        if (liveEventSource) {
          liveEventSource.close();
          liveEventSource = null;
        }

        liveEventSource = new EventSource('/api/esp32/stream');

        liveEventSource.onmessage = function (evt) {
          try {
            const payload = JSON.parse(evt.data);
            updateLiveDisplay(payload);
          } catch (err) {
            console.error('live stream parse error', err);
          }
        };

        liveEventSource.onerror = function () {
          const statusEl = document.getElementById('liveDataStatus');
          if (statusEl) {
            statusEl.textContent = '‚úó Live stream disconnected ‚Äî retrying...';
            statusEl.style.color = '#ef4444';
          }

          if (liveEventSource) {
            liveEventSource.close();
            liveEventSource = null;
          }

          if (!liveReconnectTimer) {
            liveReconnectTimer = setTimeout(function () {
              liveReconnectTimer = null;
              connectLiveStream();
            }, 5000);
          }

          startLivePolling();
        };

        liveEventSource.onopen = function () {
          const statusEl = document.getElementById('liveDataStatus');
          if (statusEl) {
            statusEl.textContent = '‚úì Live stream connected';
            statusEl.style.color = '#10b981';
          }

          if (liveReconnectTimer) {
            clearTimeout(liveReconnectTimer);
            liveReconnectTimer = null;
          }

          stopLivePolling();
        };
      }

      document.addEventListener('visibilitychange', function () {
        if (document.visibilityState === 'visible') {
          connectLiveStream();
        }
      });

      function addLiveDataToForm() {
        if (!latestEsp32Data || latestEsp32Data.weight === null) {
          alert('No live data available to add');
          return;
        }

        document.getElementById('weight').value = latestEsp32Data.weight.toFixed(2);
        document.getElementById('volume').value = latestEsp32Data.volume.toFixed(2);

        calculatePrice();

        document.getElementById('addForm').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        const statusEl = document.getElementById('liveDataStatus');
        const originalText = statusEl.textContent;
        const originalColor = statusEl.style.color;
        statusEl.textContent = '‚úì Data added to form!';
        statusEl.style.color = '#10b981';
        setTimeout(() => {
          statusEl.textContent = originalText;
          statusEl.style.color = originalColor;
        }, 2000);
      }

      connectLiveStream();
      if (!window.EventSource) {
        startLivePolling();
      }

      // Refresh chart data
      async function refreshChart() {
        try {
          var res = await fetch('/api/dashboard/chart');
          if (!res.ok) throw new Error('Status ' + res.status);
          var data = await res.json();
          if (feeChart) feeChart.destroy();
          feeChart = renderChart(data);
        } catch (e) {
          console.error('refreshChart error', e);
        }
      }

      // Expose refresh to console for quick testing
      window.refreshRecent = refreshRecent;
      window.refreshChart = refreshChart;
    </script>
  </body>
</html>